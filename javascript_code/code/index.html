<!doctype html>
<html>

<head>
    <title>张家板桥</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" type="text/css" href="../Cesium-1.108/Build/Cesium/Widgets/widgets.css">
    <script type="text/javascript" src="../Cesium-1.108/Build/Cesium/Cesium.js"></script>
    <style>
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .cesium-widget-credits {
            display: none !important;
        }

        #startButton {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #AnimationButton {
            position: absolute;
            top: 20px;
            right: 110px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>

<body>
    <div id="cesiumcontainer" style="width:100%;height:100%"></div>
    <button id="startButton">Start</button>
    <button id="AnimationButton">Animation</button>
    <script type="text/javascript">
        Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlODBjMmY1YS00NjZjLTQwZjUtYTVhNy05NDBiODliYWYwMzUiLCJpZCI6MTU1ODM0LCJpYXQiOjE2OTAwOTA4MTN9.s-rWLcdw5_e2j9Fz2l41ydsl23lAVJg2Q3XhThRUeRM";

        const viewer = new Cesium.Viewer("cesiumcontainer", {
            //搜索框
            geocoder: false,
            //home键
            homeButton: false,
            // 动画控件
            animation: false,
            //全屏按钮
            fullscreenButton: false,
            //场景模式选择器
            sceneModePicker: false,
            //时间轴
            timeline: false,
            //导航提示
            navigationHelpButton: false,
            //地图选择器
            baseLayerPicker: false,
            // imageryProvider: new Cesium.UrlTemplateImageryProvider({
            //     url: "http://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}",
            //     minimumLevel: 1,
            //     maximumLevel: 18
            // }),
            // terrain: Cesium.Terrain.fromWorldTerrain({
            //     // requestWaterMask: true,
            //     // requestVertexNormals: true,
            // }),
        })

        // viewer.imageryLayers.add(
        //     new Cesium.ImageryLayer(new Cesium.UrlTemplateImageryProvider({
        //         url: "https://wprd01.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scl=1&style=8&ltype=4",
        //         minimumLevel: 1,
        //         maximumLevel: 18
        //     }))
        // )

        // viewer.terrainProvider = new Cesium.CesiumTerrainProvider({
        //     url: "./terrain/",
        // })



        // 将视角定位到指定的经纬度
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(113.39811, 31.699212, 4000.0), // 例如：1000
            orientation: {
                heading: Cesium.Math.toRadians(0.0), // 指定航向角度
                pitch: Cesium.Math.toRadians(-90.0), // 指定俯仰角度
                roll: 0.0 // 指定翻滚角度
            }
        })



        // 预加载按钮模块
        let currentTileset, prevTileset;
        async function renderTilesetWithAnimation(assetIdArray) {
            assetIdArray.forEach(async (assetId) => {
                try {
                    // viewer.scene.primitives.removeAll(); // Clear the previous tileset
                    // console.dir(viewer.scene.primitives)
                    console.log(viewer.scene.primitives.length);
                    console.log(assetId);
                    // if (currentTileset?.show) {
                    //     currentTileset.show = false;
                    // }
                    currentTileset = await Cesium.Cesium3DTileset.fromIonAssetId(assetId, {
                        show: false,
                        preloadWhenHidden: true,
                    });
                    currentTileset.maximumScreenSpaceError = 1; // Set to a smaller value for highest LOD accuracy

                    const tileset = await viewer.scene.primitives.add(currentTileset);

                } catch (error) {
                    console.log(error);
                }
            });
        }


        const assetIdArray = [2221226, 2221227, 2221228, 2221231, 2221232, 2221233, 2221234, 2221236, 2221237, 2221239, 2221240, 2221241, 2221242, 2221243, 2221244, 2221245, 2221247, 2221248, 2221250, 2221255, 2221256, 2221258, 2221259, 2221260, 2221261, 2221263, 2221264, 2221266, 2221267, 2221268, 2221269, 2221321, 2221322, 2221323, 2221324, 2221325, 2221326, 2221327, 2221328, 2221329, 2221330, 2221331, 2221333, 2221334, 2221335, 2221336, 2221337, 2221338, 2221340, 2221341, 2221342, 2221343, 2221344, 2221345, 2221346, 2221347, 2221348, 2221350, 2221351, 2221352, 2221353, 2221357, 2221359, 2221360, 2221361, 2221364, 2221365, 2221366, 2221367, 2221368, 2221369, 2221370, 2221371, 2221372, 2221373, 2221374, 2221375, 2221376, 2221378, 2221379, 2221380, 2221382, 2221383, 2221384, 2221385, 2221386, 2221387, 2221388, 2221389, 2221390, 2221391, 2221392, 2221393, 2221394, 2221395, 2221397, 2221398, 2221399, 2221400, 2221427, 2221429, 2221430, 2221431, 2221432, 2221433, 2221434, 2221435, 2221436, 2221438, 2221440, 2221441, 2221443, 2221444, 2221651, 2221652, 2221653, 2221654, 2221655, 2221656, 2221657, 2221659, 2221660, 2221662, 2221663, 2221664, 2221665, 2221666, 2221667, 2221668, 2221669, 2221670, 2221672, 2221673, 2221675, 2221676, 2221677, 2221679, 2221680, 2221681, 2221682, 2221683, 2221685, 2221686, 2221687, 2221688, 2221689, 2221690, 2221691, 2221692, 2221693, 2221694, 2221695, 2221696, 2221697, 2221698, 2221699, 2221700, 2221702, 2221703, 2221705, 2221706, 2221707, 2221708, 2221735, 2221736, 2221737, 2221738, 2221740, 2221742, 2221743, 2221745, 2221746, 2221748, 2221749, 2221751]

            // const assetIdArray = [2221226, 2221241, 2221260, 2221341, 2221376, 2221400, 2221444, 2221676, 2221696, 2221751]
            ;/* Add more asset IDs here */

        document.querySelector('#startButton').addEventListener('click', () => {
            renderTilesetWithAnimation(assetIdArray);
        });

        // viewer.scene.primitives._primitives
        // viewer.scene.primitives._primitives.forEach((primitive, index) => {
        //         // primitive.show = false;
        //         console.log(primitive.show)
        //     });

        // 动画按钮模块
        // 调用函数开始动画流显示
        const delayBetweenShow = 500; // 每个原始对象显示的时间间隔（毫秒）
        document.querySelector('#AnimationButton').addEventListener('click', () => {
            showPrimitivesWithAnimation(viewer.scene.primitives._primitives, delayBetweenShow);
        });

        function showPrimitivesWithAnimation(primitivesArray, delay) {
            primitivesArray.forEach((primitive, index) => {
                primitive.show = false;
                // console.log(`关闭: ${index}`)
            });

            // setTimeout(function () {
            //     delayForEach(primitivesArray, (primitive, index) => {
            //         primitive.show = false;
            //         console.log(`关闭: ${index}`);
            //     }, delayBetweenShow)
            // }, 1500);

            let currentIndex = 0;
            const length = primitivesArray.length
            const interval = setInterval(() => {
                if (currentIndex < length) {
                    // if (currentIndex - 1 >= 0) {
                    //     setTimeout(() => {
                    //         primitivesArray[currentIndex - 1].show = false;
                    //     }, delayBetweenShow * (currentIndex + 1))
                    // }
                    // if (currentIndex + 1 <= length - 1) {
                    //     primitivesArray[currentIndex + 1].show = true;
                    // }
                    intervalIndex = 1
                    if (currentIndex - intervalIndex >= 0) {
                        primitivesArray[currentIndex - intervalIndex].show = false;
                    }

                    currentTileset = primitivesArray[currentIndex]
                    primitivesArray[currentIndex].show = true;
                    console.log(`打开: ${currentIndex}`);
                    cameraHeight_changed()
                    // primitive_show(currentIndex, 1, true)
                    currentIndex++;
                    console.log("------------------")
                    // viewer.scene.primitives._primitives.forEach((primitive, index) => {
                    //     // primitive.show = false;
                    //     console.log(primitive.show)
                    // });
                } else {
                    clearInterval(interval); // 停止定时器
                }
            }, delay);
        }

        async function delayForEach(array, callback, delayMs) {
            for (let i = 0; i < array.length; i++) {
                callback(array[i], i);
                await delay(delayMs); // 使用之前定义的 delay 函数
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        // function primitive_show(end_index, length, bool) {
        //     start_index = end_index - length
        //     viewer.scene.primitives._primitives.forEach((primitive, index) => {
        //         if (index >= start_index && index <= end_index) { primitive.show = bool; console.log(`打开: ${index}`); }
        //         else { primitive.show = !bool; }
        //     });
        //     // return viewer.scene.primitives._primitives[start_index, end_index]
        // }
        // function primitive_show(end_index, length, bool) {
        //     if (!viewer || !viewer.scene || !viewer.scene.primitives || !viewer.scene.primitives._primitives) {
        //         // 检查是否存在必要的对象，以避免错误
        //         console.log("Viewer or required properties do not exist.");
        //         return;
        //     }

        //     const primitives = viewer.scene.primitives._primitives;

        //     for (let i = 0; i < primitives.length; i++) {
        //         const primitive = primitives[i];

        //         // 确保 primitive 有 'show' 属性
        //         if (primitive.hasOwnProperty('show')) {
        //             if (i >= end_index - length && i <= end_index) {
        //                 // 在指定范围内设置 'show' 属性为给定的布尔值
        //                 primitive.show = bool;
        //             } else {
        //                 // 在指定范围外设置 'show' 属性为布尔值的反义值
        //                 primitive.show = !bool;
        //             }
        //         }
        //     }
        // }


        // 监控cameraHeight 调整currentTileset.style
        viewer.camera.changed.addEventListener(cameraHeight_changed())

        function cameraHeight_changed() {
            if (currentTileset) {
                // 获取相机的高度
                let cameraHeight = viewer.camera.positionCartographic.height;
                // if (cameraHeight > 4000) {
                //     viewer.camera.positionCartographic.height = 4000
                // }
                console.log(cameraHeight)
                // 根据相机高度调整点云显示像素大小
                if (cameraHeight < 100) {
                    pointCloudPixelSize = 15
                } else if (cameraHeight < 300) {
                    pointCloudPixelSize = 10
                } else if (cameraHeight < 500) {
                    pointCloudPixelSize = 8
                } else if (cameraHeight < 700) {
                    pointCloudPixelSize = 6
                } else if (cameraHeight < 1000) {
                    pointCloudPixelSize = 5
                } else if (cameraHeight < 2000) {
                    pointCloudPixelSize = 3
                } else if (cameraHeight < 4000) {
                    pointCloudPixelSize = 2
                } else {
                    pointCloudPixelSize = 1
                }

                // 更新点云的显示像素大小
                currentTileset.style = new Cesium.Cesium3DTileStyle({
                    pointSize: pointCloudPixelSize // 设置为您想要的点大小
                });
            }

        }
    </script>
</body>

</html>